name: QA Tests

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  qa:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Docker Compose
        run: docker compose up -d

      - name: Wait for MySQL to be ready
        run: |
          until docker exec sortirentreamis_db mysqladmin ping -h "localhost" --silent; do
            echo "Waiting for database..."
            sleep 2
          done

      - name: Install dependencies
        run: docker exec symfony_app composer install --no-interaction --prefer-dist

      - name: Run PHPUnit with coverage
        run: |
          docker exec symfony_app bash -c "
          vendor/bin/phpunit --log-junit var/test-results/junit.xml \
                             --coverage-clover var/coverage/clover.xml \
                             --colors=always
          "

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: junit-results
          path: var/test-results/

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: var/coverage/

      - name: Show KPI summary
        run: |
          echo "ðŸ“Š KPI Summary:"
          docker exec symfony_app bash -c "
          TESTS_TOTAL=\$(grep '<testsuites tests' var/test-results/junit.xml | sed 's/.*tests=\"\([0-9]*\)\".*/\1/')
          TESTS_FAILURES=\$(grep '<testsuite ' var/test-results/junit.xml | grep failures | sed 's/.*failures=\"\([0-9]*\)\".*/\1/' | awk '{s+=$1} END {print s}')
          COVERAGE=\$(grep '<coverage' var/coverage/clover.xml | sed 's/.*line-rate=\"\([0-9.]*\)\".*/\1/')
          echo \"Total tests: \$TESTS_TOTAL\"
          echo \"Failed tests: \$TESTS_FAILURES\"
          echo \"Code coverage: \$(echo \"\$COVERAGE*100\" | bc)%\"
          "
