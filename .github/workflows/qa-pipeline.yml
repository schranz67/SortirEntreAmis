name: Symfony CI/CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  # -------------------------------
  # 1️⃣ Build et push Docker image
  # -------------------------------
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Build Docker image
        run: docker build -t schranz67/sortirentreamis:latest .

      - name: Push Docker image
        run: docker push schranz67/sortirentreamis:latest

  # -------------------------------
  # 2️⃣ Tests Symfony avec MySQL
  # -------------------------------
  run-tests:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # Lancer MySQL
      - name: Start MySQL container
        run: |
          docker run -d --name test-db \
            -e MYSQL_ROOT_PASSWORD=root1234 \
            -e MYSQL_DATABASE=sortirentreamis \
            mysql:latest

      # Attendre que MySQL soit prêt
      - name: Wait for MySQL
        run: |
          until docker exec test-db mysqladmin ping -uroot -proot1234 --silent; do
            sleep 5
          done

      # Pull et exécuter l'image Docker depuis Docker Hub
      - name: Run Symfony tests
        run: |
          docker pull schranz67/sortirentreamis:latest
          docker run --rm --link test-db:database schranz67/sortirentreamis:latest \
          sh -c "composer install --no-interaction && \
                 php bin/console doctrine:migrations:migrate --no-interaction && \
                 php bin/phpunit"

  # -------------------------------
  # 3️⃣ Déploiement QA
  # -------------------------------
  deploy-qa:
    runs-on: ubuntu-latest
    needs: run-tests
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Deploy QA environment
        run: |
          python orchestrator.py --deploy \
            --image schranz67/sortirentreamis:latest \
            --env QA

  # -------------------------------
  # 4️⃣ Vérification post-déploiement
  # -------------------------------
  health-check:
    runs-on: ubuntu-latest
    needs: deploy-qa
    steps:
      - name: Health check QA
        run: |
          curl -f http://localhost:8025/health || exit 1
